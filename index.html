<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <style>
      a { color: #44f !important; text-decoration: none }
      a+a { margin-left: 0.75rem }
      body { background: #fafafa; color: #444; font-family: sans-serif; line-height: 1.5rem; padding: 1rem; text-align: center }
      h3 { font-weight: 100; margin: 0.125rem; text-transform: lowercase; }
      p { margin: 0 }
      section { margin: 1.25rem }
    </style>
  </head>
  <body>
    <script>
      // base domain for ipns
      const DOMAIN = 'dotapps.io';

      // alternative gateways, [name, host]
      const GATEWAYS = [
        ['CloudFlare', 'https://cloudflare-ipfs.com'],
        ['IPFS', 'https://gateway.ipfs.io'],
        ['Pinata', 'https://gateway.pinata.cloud'],
        ['Temporal', 'https://gateway.temporal.cloud']
      ];

      // timeout in seconds
      const TIMEOUT = 5;

      // create a section with a title and links as <section><h3>...</h3><p><a>...</a><a>...</a></p></section>
      function createSection (title, links) {
        const section = document.createElement('section');
        const h = document.createElement('h3');
        const p = document.createElement('p');

        for (let i = 0; i < links.length; i++) {
          const [text, host, path] = links[i];
          const a = document.createElement('a');

          a.appendChild(document.createTextNode(text));
          a.href = `${host}/${path}`;
          p.appendChild(a);
        }

        h.appendChild(document.createTextNode(title));
        section.appendChild(h);
        section.appendChild(p);
        document.body.appendChild(section);
      }

      // parse the query, returning the chain
      function getChain () {
        const query = window.location.search.substring(1).split('&').reduce((query, kv) => {
          const [key, value] = kv.split('=');

          query[decodeURIComponent(key)] = decodeURIComponent(value);

          return query;
        }, {});

        return query.chain;
      }

      // lookup an ipfs hash based on the given ipns domain
      async function lookupHash (domain) {
        const result = await fetch(`https://ipfs.io/api/v0/name/resolve?arg=${domain}`);

        if (result.status !== 200) {
          throw new Error(`Received status=${result.status} on lookup`);
        }

        const { Path } = await result.json();

        return Path;
      }

      // main entry point
      async function main () {
        const chain = getChain();
        const ipns = `ipns/${chain ? `${chain}.` : ''}${DOMAIN}`;

        window.document.title = `Redirecting to ${ipns}`;

        createSection(`Redirecting in ${TIMEOUT}s`, [[`ipfs.io/${ipns}`, 'https://ipfs.io', ipns]]);
        createSection('Alternative ipns-capable gateways', GATEWAYS.map(([title, host]) => [title, host, ipns]));

        setTimeout(() => {
          window.location.href = `https://ipfs.io/${ipns}`;
        }, TIMEOUT * 1000);

        const path = await lookupHash(DOMAIN);
        const hash = path.replace('/ipfs/', '');

        createSection('Link via content hash', [[`${hash.substr(0, 8)}â€¦${hash.substr(-8)}`, 'https://ipfs.io', path]]);
      }

      main().catch(console.error);
    </script>
  </body>
</html>
